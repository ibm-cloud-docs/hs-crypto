---

copyright:
  years: 2020, 2021
lastupdated: "2021-08-09"

keywords: encrypt IBM Db2 databases, database encryption, PKCS11, Db2 native encryption using PKCS11

subcollection: hs-crypto

content-type: tutorial
services: hs-crypto
account-plan: paid
completion-time: 2h

---

{:shortdesc: .shortdesc}
{:screen: .screen}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:external: target="_blank" .external}
{:codeblock: .codeblock}
{:tip: .tip}
{:note: .note}
{:important: .important}
{:step: data-tutorial-type='step'}

# Tutorial: Using {{site.data.keyword.hscrypto}} PKCS #11 for IBM Db2 native encryption
{: #tutorial-db2-pkcs11}
{: toc-content-type="tutorial"}
{: toc-completion-time="2h"}

IBM Db2Â® native encryption protects key database files and database backup images from inappropriate access while they are stored on external storage media. The database system automatically encrypts and decrypts data when it is used by authorized users and applications. Typically, database users do not need to be aware of native encryption and database client applications do not need to be adapted specifically.
{: shortdesc}

Db2 native encryption uses a two-tiered key hierarchy: Data is encrypted with a data encryption key (DEK). The DEK is encrypted with a master key and is stored in encrypted form with the database or the backup image. A unique DEK is generated by Db2 for each encrypted database and for each encrypted backup.

A master key is used to encrypt a DEK. Each encrypted database is associated with one master key at one time.

One important question when you plan for Db2 native encryption is where you keep the master key and how you secure it.

## Objectives
{: #tutorial-db2-objectives}

This tutorial shows how you can keep complete and exclusive control of your master keys by storing them in {{site.data.keyword.cloud}} {{site.data.keyword.hscrypto}}. For this purpose, you need to use the PKCS #11 integration feature of {{site.data.keyword.hscrypto}}.

With this tutorial, you are going to implement the setup that is depicted in the following illustration.

![IBM Db2 default encryption with the standard PKCS #11 API](../images/pkcs_db2.svg "IBM Db2 default encryption with the standard PKCS #11 API"){: caption="Figure 1. IBM Db2 default encryption with the standard PKCS #11 API" caption-side="bottom"}

In this setup, Db2 is to call operations to manage the master keys on the {{site.data.keyword.hscrypto}} PKCS #11 library. The {{site.data.keyword.hscrypto}} PKCS #11 library interacts with your {{site.data.keyword.hscrypto}} instance, which provides the best of class technology for storing and managing your master keys.

## Before you begin
{: #tutorial-db2-prerequisites}

To complete this tutorial, you need to meet the following prerequisites:

- [Sign up an {{site.data.keyword.cloud_notm}} account](/docs/vmwaresolutions?topic=vmwaresolutions-signing_required_accounts#signing_required_accounts-cloud)
- [Provision a {{site.data.keyword.hscrypto}} instance](/docs/hs-crypto?topic=hs-crypto-provision)

## Task flow
{: #tutorial-db2-steps}

To complete this solution, let's walk through the following steps:

1. [Initialize your {{site.data.keyword.hscrypto}} instance](#tutorial-db2-initialize)
1. [Set up the {{site.data.keyword.hscrypto}} PKCS #11 library](#tutorial-db2-pkcs11-setup)
1. [Set up Db2 and configure Db2 native encryption](#tutorial-db2-encrypt)

## Initialize your {{site.data.keyword.hscrypto}} instance
{: #tutorial-db2-initialize}
{: step}

1. For this tutorial, you need to [initialize a {{site.data.keyword.hscrypto}} instance first](/docs/hs-crypto?topic=hs-crypto-initialize-hsm).

    Note down the ID of your {{site.data.keyword.hscrypto}} instance and the EP11 endpoint address. You need this information for the subsequent steps.

2. Generate an API key for accessing your {{site.data.keyword.hscrypto}} instance. Run the following command to create an API key for your {{site.data.keyword.cloud_notm}} account:

    ```
    ibmcloud iam api-key-create apikeyhpcs -d "API key for {{site.data.keyword.hscrypto}} PKCS11"
    ```
    {: codeblock}

3. Save the value of the API key for subsequent steps.

## Set up the {{site.data.keyword.hscrypto}} PKCS #11 library
{: #tutorial-db2-pkcs11-setup}
{: step}

### 1. Run the Db2 Community Edition container
{: #tutorial-db2-community-container}

1. Use the following command to run the Db2 Community Edition container:

    ```
    docker run -itd --name mydb --privileged=true -p 50000:50000 -e LICENSE=accept -e DB2INST1_PASSWORD=password -e DBNAME=testdb ibmcom/db2
    ```
    {: codeblock}

2. Run the following command from a command line on your host system:

    ```
    docker exec -it --user root --workdir / mydb bash
    ```
    {: codeblock}

This shell is to be used to run the commands as `root` for the subsequent steps.

### 2. Create the {{site.data.keyword.hscrypto}} PKCS #11 configuration file
{: #tutorial-db2-config-setup}

Now, create a configuration file for the {{site.data.keyword.hscrypto}} PKCS #11 feature. The configuration file is named `grep11client.yaml`.

Adapt the following file template and name the file `grep11client.yaml`:

- Replace `<instance_id>` with the ID of your {{site.data.keyword.hscrypto}} instance
- Replace `<EP11_endpoint_URL>` and `<EP11_endpoint_port_number>` with the respective parameters of the EP11 endpoint address of your {{site.data.keyword.hscrypto}} instance
- Replace `<your_api_key>` with the value of the API key that you created previously

```yaml
iamcredentialtemplate: &defaultiamcredential
          enabled: true
          endpoint: "https://iam.cloud.ibm.com"
          # Keep the 'apikey' empty. It will be overridden by the Anonymous user API key configured later.
          apikey:
          # The Universally Unique IDentifier (UUID) of your {{site.data.keyword.hscrypto}} instance.
          instance: "<instance_id>"

tokens:
  0:
    grep11connection:
      # The EP11 endpoint address starting from 'ep11'.
      # For example: "ep11.us-south.hs-crypto.cloud.ibm.com"
      address: "<EP11_endpoint_URL>"
      # The EP11 endpoint port number
      port: "<EP11_endpoint_port_number>"
      tls:
        # Grep11 requires TLS connection.
        enabled: true
        # Grep11 requires server only authentication, so 'mutual' needs to be set as 'false'.
        mutual: false
        # 'cacert' is a full-path certificate file.
        # In Linux with the 'ca-ca-certificates' package installed, this is normally not needed.
        cacert:
        # Grep11 requires the server-only authentication, so 'certfile' and 'keyfile' need to be empty.
        certfile:
        keyfile:
    storage:
      filestore:
        enabled: false
        storagepath:
        # 'remotestore' needs to be enabled if you want to generate keys with the attribute CKA_TOKEN.
      remotestore:
        enabled: true
    users:
      0: # The index of the Security Officer (SO) user MUST be 0.
        # The name for the Security Officer (SO) user. For example: "Administrator".
        # NEVER put the API key under the SO user for security reasons.
        name: "Administrator"
        iamauth:
          <<: *defaultiamcredential
      1: # The index of the normal user MUST be 1.
        # The name for the normal user. For example: "Normal user".
        # NEVER put the API key under the normal user for security reasons.
        name: "Normal user"
         # The Space ID is a 128-bit UUID and can be chosen freely.
         # The UUID can be generated by third-party tools, such as 'https://www.uuidgenerator.net/'.
         # For example: "f00db2f1-4421-4032-a505-465bedfa845b".
         # 'tokenspaceID' under the normal user is to identify the private keystore.
        tokenspaceID: "f00db2f1-4421-4032-a505-465bedfa845b"
        iamauth:
          <<: *defaultiamcredential
      2: # The index of the anonymous user MUST be 2.
        # The name for the anonymous user. For example: "Anonymous".
        name: "Anonymous"
        # The Space ID is a 128-bit UUID and can be chosen freely.
        # The UUID can be generated by third-party tools, such as 'https://www.uuidgenerator.net/'.
        # For example: "ca22be26-b798-4fdf-8c83-3e3a492dc215".
        # 'tokenspaceID' under the anonymous user is to identify the public keystore.
        tokenspaceID: "ca22be26-b798-4fdf-8c83-3e3a492dc215"
        iamauth:
          <<: *defaultiamcredential
          # This API key for the Anonymous user must be provided.
          # It will overide the 'apikey' in the previous defaultcredentials.iamauth.apikey field
          apikey: "<your_api_key>"
logging:
  # Set the logging level.
  # The supported levels, in an increasing order of verboseness, are:
  # 'panic', 'fatal', 'error', 'warning'/'warn', 'info', 'debug', 'trace'.
  # The Default value is 'debug'.
  loglevel: debug
  # The full path of your logging file.
  # For example: /tmp/grep11client.log
  logpath: /tmp/grep11client.log
```
{: codeblock}

### 3. Install the {{site.data.keyword.hscrypto}} PKCS #11 library
{: #tutorial-db2-install-library}

1. [Download the latest PKCS #11 library](https://github.com/IBM-Cloud/hpcs-pkcs11/releases){: external}.

2. Copy the previously created configuration file `grep11client.yaml` and the PKCS #11 library `pkcs11-grep11-<platform>.so.<version>` into your Db2 container.

3. Run the following commands as `root` to install the {{site.data.keyword.hscrypto}} PKCS #11 library in your Db2 setup.

    ```linux
    mkdir /etc/ep11client
    chmod a+rx /etc/ep11client/
    cp grep11client.yaml /etc/ep11client/grep11client.yaml
    chmod a+r /etc/ep11client/grep11client.yaml

    mkdir -p /pkcs11
    cp pkcs11-grep11.so /pkcs11/pkcs11-grep11.so
    chmod -R a+rwx /pkcs11

    touch /tmp/grep11client.log
    chmod a+rw /tmp/grep11client.log
    ```
    {: codeblock}

### 4. Initialize the {{site.data.keyword.hscrypto}} PKCS #11 library
{: #tutorial-db2-initialize-library}

1. Install the command-line utility OpenSC (pkcs11-tool) with the following command:

    ```
    yum install opensc
    ```
    {: codeblock}

2. Run the following command as `root` to initialize the library setup.

    ```
    pkcs11-tool --module=/pkcs11/pkcs11-grep11.so -I
    ```
    {: codeblock}

    This command prints information about the manufacturer and the library, for example:

    ```
    Cryptoki version 2.40
    Library          GREP11 PKCS11 client ...
    ```
    {: screen}

3. To initialize a token, run the following commands and replace `<your_api_key>` by the API key that you created.

    ```
    pkcs11-tool  --module /pkcs11/pkcs11-grep11.so --init-token --label dbtoken --so-pin <your api key>
    ```
    {: codeblock}

    This command prints the following status message, for example:

    ```
    Using slot 0 with a present token (0x0)
    Token successfully initialized
    ```
    {: screen}

## Set up Db2 native encryption
{: #tutorial-db2-encrypt}
{: step}

Now, let's set up Db2 native encryption. To do so, make sure that you have all database administrator privileges.

1. Create the file `/pkcs11/keystore.conf` with the following content:

    ```
    VERSION=1
    PRODUCT_NAME=Other
    ALLOW_KEY_INSERT_WITHOUT_KEYSTORE_BACKUP=true
    LIBRARY=/pkcs11/pkcs11-grep11.so
    SLOT_ID=0
    NEW_OBJECT_TYPE=PRIVATE
    KEYSTORE_STASH=/pkcs11/pkcs11_pw.sth
    ```
    {: codeblock}

2. Run the following commands as `root` to update ownership and permissions of file `/pkcs11/keystore.conf`:

    ```
    chown -R db2inst1:db2iadm1 /pkcs11/keystore.conf
    chmod ug+rw /pkcs11/keystore.conf
    ```
    {: codeblock}

3. To create a password stash file, run the following commands and replace <your_api_key> by the API key that you created.

    ```
    su - db2inst1
    db2credman -stash -password <your api key> -to /pkcs11/pkcs11_pw.sth
    ```
    {: codeblock}

4. To update the Db2 configuration, run the following command as user `db2inst1`:

    ```
    db2 update dbm cfg using keystore_location /pkcs11/keystore.conf  keystore_type pkcs11
    ```
    {: codeblock}

5. To set the environment variable `DB2_DEK_MAC_TYPE`, run the following commands as user `db2inst1` and restart DB2:

    ```
    db2 terminate
    db2stop
    export DB2_DEK_MAC_TYPE=HMAC
    db2start
    ```
    {: codeblock}

    You need to specify the environment variable `DB2_DEK_MAC_TYPE=HMAC` before you start Db2. If you use Db2 on Windows, you need to set the Db2 profile variable by using the following command:
    {: note}

    ```
    db2set -g DB2_DEK_MAC_TYPE=HMAC
    ```
    {: codeblock}

6. To create an encrypted database, run the following commands:

    ```
    db2 create db cryptdb1 encrypt
    ```
    {: codeblock}

    This command prints the following information:

    ```
    DB20000I  The CREATE DATABASE command completed successfully.
    ```
    {: screen}

7. To test the encrypted database, run the following commands:

    ```
    db2 connect to cryptdb1
    db2 "create table test (id int not null, data varchar(100))"
    db2 "insert into test values (1, 'This is a secret text')"
    db2 "select * from test"
    ```
    {: codeblock}

    This command prints the following information:

    ```
    ID          DATA
    ----------- ----------------------------------------------------------------------------------------------------
          1 This is a secret text

    1 record(s) selected.
    ```
    {: screen}

## Next steps
{: #tutorial-db2-summary}

Your sensitive data is now stored safely in encrypted storage. And the master key is kept in {{site.data.keyword.hscrypto}} in a highly secure and tamper-proof manner.

In this tutorial, you learned how to set up Db2 native encryption with {{site.data.keyword.hscrypto}}.

- Learn more about [PKCS #11](/docs/hs-crypto?topic=hs-crypto-pkcs11-intro).
- Learn more about the [PKCS #11 API](/docs/hs-crypto?topic=hs-crypto-pkcs11-api-ref).
- [Start to use the PKCS #11 API](/docs/hs-crypto?topic=hs-crypto-set-up-pkcs-api).
